{% extends 'base.html' %}
{% block content %}
  <div id="container" class="container">
   <div id="content" class="content" style="margin-top: 40px;">
    <div class="relative" style="padding: 5px;position: relative;">
      <div id="sceneMap" style="height:600px;border:1px solid #ccc;padding-top: 80px;"></div>
      <div id="date-filter-wrap" class="date-filter-wrap" >
        <div class="filter-by-day" style="text-align: right;">
          <a class="today" href="javascript:;">今日</a>
          <a class="yestoday" href="javascript:;">昨日</a>
          <a class="lastweek" href="javascript:;">最近一周</a>
          <a class="lastmouth" href="javascript:;">最近一月</a>
          <input type="button" class="more" value="更多">
        </div>
        <div class="date-wrap">
          <input id="j-filter-start-at">至
          <input id="j-filter-end-at">
        </div>
      </div>
    </div>

    <div class="relative" style="padding: 5px; position: relative;">
      <div id="eventMap" style="height:600px;border:1px solid #ccc;padding-top: 80px;"></div>
      <div id="e-date-filter-wrap" class="date-filter-wrap" >
        <div class="filter-by-day" style="text-align: right;">
          <a class="today" href="javascript:;">今日</a>
          <a class="yestoday" href="javascript:;">昨日</a>
          <a class="lastweek" href="javascript:;">最近一周</a>
          <a class="lastmouth" href="javascript:;">最近一月</a>
          <input type="button" class="more" value="更多">
        </div>
        <div class="date-wrap">
          <input id="j-e-filter-start-at">至
          <input id="j-e-filter-end-at">
        </div>
      </div>
    </div>

   </div>
  </div>
<script>
var profile = JSON.parse({{ option|tojson|safe }});

var render_home_office = function(profile){
   var sceneMapOption = option = {
        title : {
            text: '家-工作地点状态',
            subtext: ''
        },
        tooltip : {
            trigger: 'axis'
        },
        legend: {
            data: profile.data.home_office.category
        },
        toolbox: {
            show : true,
            feature : {
                mark : {show: true},
                dataView : {show: true, readOnly: false},
                magicType : {show: true, type: ['line', 'bar', 'stack', 'tiled']},
                restore : {show: true},
                saveAsImage : {show: true}
            }
        },
        calculable : true,
        xAxis : [
            {
                type : 'category',
                boundaryGap : false,
                data : profile.data.home_office.xAxis
            }
        ],
        yAxis : [
            {
                type : 'value'
            }
        ],
        series : [
            {
                name: profile.data.home_office.category[1],
                type: 'line',
                smooth: true,
                itemStyle: {normal: {areaStyle: {type: 'default'}}},
                data: profile.data.home_office.series[1]
            },
            {
                name: profile.data.home_office.category[0],
                type:'line',
                smooth:true,
                itemStyle: {normal: {areaStyle: {type: 'default'}}},
                data: profile.data.home_office.series[0]
            },
            {
                name: profile.data.home_office.category[2],
                type:'line',
                smooth:true,
                itemStyle: {normal: {areaStyle: {type: 'default'}}},
                data: profile.data.home_office.series[2]
            },
            {
                name: profile.data.home_office.category[3],
                type:'line',
                smooth:true,
                itemStyle: {normal: {areaStyle: {type: 'default'}}},
                data: profile.data.home_office.series[3]
            }
        ]
    };

    require(['echarts', 'echarts/chart/bar', 'echarts/chart/line', 'echarts/chart/map'],
        function(ec) {

            if(!document.getElementById('sceneMap')){
                return;
            }
            var sceneMap = ec.init(document.getElementById('sceneMap'));
            sceneMap.setOption(sceneMapOption);
        });

        require.config({
          paths: {
              echarts: './public/lib/echarts-2.2.7/build/dist'
          }
      });
};

var render_context = function(profile){
     var eventMapOption = {
          title : {
              text: '事件频次',
              subtext: ''
          },
          tooltip: {
              trigger: 'axis'
          },
          legend: {
              show: false,
              data: ['']
          },
          toolbox: {
              show: true,
              feature: {
                  mark: {
                      show: true
                  },
                  dataView: {
                      show: true,
                      readOnly: false
                  },
                  magicType: {
                      show: true,
                      type: ['line', 'bar']
                  },
                  restore: {
                      show: true
                  },
                  saveAsImage: {
                      show: true
                  }
              }
          },
          calculable: true,
          xAxis: [{
              type: 'category',
              data: profile.data.event.category,
              show: true

          }],
          yAxis: [{
              type: 'value',
              splitArea: {
                  show: true
              }
          }],
          series: [{
              name: '事件频次',
              type: 'bar',
              data: profile.data.event.series
          }]
      };

      require(['echarts', 'echarts/chart/bar', 'echarts/chart/line', 'echarts/chart/map'],
      function(ec) {
          //--- 折柱 ---
          if(!document.getElementById('eventMap')){
              return;
          }
          var eventMap = ec.init(document.getElementById('eventMap'));
          eventMap.setOption(eventMapOption);
      })
};
render_home_office(profile);
render_context(profile);

$(document).ready(function(){
    $(".date-filter-wrap").on("click", ".more", function(e){
        $(this)
          .closest(".filter-by-day")
          .next()
          .slideToggle(200);
    });

    var now = new Date();
    $("#j-filter-start-at").datepicker({
        dateFormat: "yy-mm-dd",
        defaultDate: now
    });

    $("#j-filter-end-at").datepicker({
        dateFormat: "yy-mm-dd",
        defaultDate: now,
        onClose: function(selectedDate){
            var url = "{{ url_for('dashboard_bp.motion') }}";
            var data = {
                name: "home_office_status",
                h_start: (+new Date($("#j-filter-start-at").val())) || null,
                h_end: (+new Date($("#j-filter-end-at").val())) || null
            };

            $.ajax({
                type: "post",
                async: true,
                url: url,
                data: data,
                success: function (option) {
                    render_home_office(JSON.parse(option));
                },
                error: function () {
                    alert("获取内容失败，请稍后再试！");
                }
            });
        }
    });

    $("#j-e-filter-start-at").datepicker({
        dateFormat: "yy-mm-dd",
        defaultDate: now
    });

    $("#j-e-filter-end-at").datepicker({

        dateFormat: "yy-mm-dd",
        defaultDate: now,
        onClose: function(selectedDate){
            var url = "{{ url_for('dashboard_bp.motion') }}";
            var data = {
                name: "context",
                h_start: (+new Date($("#j-e-filter-start-at").val())) || null,
                h_end: (+new Date($("#j-e-filter-end-at").val())) || null,
            };

            $.ajax({
                type: "post",
                async: true,
                url: url,
                data: data,
                success: function (option) {
                    render_context(JSON.parse(option));
                },
                error: function () {
                    alert("获取内容失败，请稍后再试！");
                }
            });
        }
    })
});

$(".date-filter-wrap a").on("click", function(){
    var _today = (+new Date());
    var h_start = (_today - (86400000*30)) || null;
    var e_start = (_today - (86400000*30)) || null;

    switch ($(this).attr('class')) {
        case 'today':
            h_start = _today || null;
            e_start = _today || null;
            break;
        case 'yestoday':
            h_start = (_today - 86400000) || null;
            e_start = (_today - 86400000) || null;
            break;
        case 'lastweek':
            h_start = (_today - (86400000*7)) || null;
            e_start = (_today - (86400000*7)) || null;
            break;
        case 'lastmouth':
            break;
        default :
            break;
    }
    var url = "{{ url_for('dashboard_bp.motion') }}";
    var data = {
        name: $(this).parent().parent().attr('id') == "date-filter-wrap"
                ? "home_office_status": "context",
        h_start: h_start,
        h_end: _today || null,
        e_start: e_start,
        e_end: _today || null
    };

    $.ajax({
        type: "post",
        async: true,
        url: url,
        data: data,
        success: function (option) {
            if (data.name == 'home_office_status') {
                render_home_office(JSON.parse(option));
            } else if (data.name == 'context') {
                render_context(JSON.parse(option));
            }
        },
        error: function () {
            alert("获取内容失败，请稍后再试！");
        }
    });
});

</script>
{% endblock %}